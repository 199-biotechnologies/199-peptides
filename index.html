<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ducu & Bo' Peptides</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #1a1a2e;
            --accent: #4a6fa5;
            --accent-hover: #3d5d8a;
            --text: #2d3748;
            --text-light: #718096;
            --bg: #f7fafc;
            --bg-paper: #ffffff;
            --border: #e2e8f0;
            --success: #38a169;
            --warning: #d69e2e;
            --danger: #e53e3e;
            --topbar-height: 56px;
        }

        [data-theme="dark"] {
            --primary: #e2e8f0;
            --accent: #63b3ed;
            --accent-hover: #4299e1;
            --text: #e2e8f0;
            --text-light: #a0aec0;
            --bg: #1a202c;
            --bg-paper: #2d3748;
            --border: #4a5568;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--bg);
        }

        /* Password Screen */
        .password-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .password-screen.hidden { display: none; }

        .password-box {
            background: var(--bg-paper);
            padding: 2.5rem 2rem;
            border-radius: 16px;
            text-align: center;
            max-width: 360px;
            width: calc(100% - 2rem);
            margin: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        .password-box h1 {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .password-box p { color: var(--text-light); margin-bottom: 2rem; }
        .password-box input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            outline: none;
            background: var(--bg);
            color: var(--text);
        }
        .password-box input:focus { border-color: var(--accent); }
        .password-box input.error { border-color: var(--danger); animation: shake 0.5s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .password-box button {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .password-box button:hover { background: var(--accent-hover); }
        .error-msg { color: var(--danger); margin-top: 1rem; display: none; }
        .error-msg.visible { display: block; }

        /* App Layout */
        .app { display: none; flex-direction: column; min-height: 100vh; }
        .app.visible { display: flex; }

        /* Top Bar */
        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--topbar-height);
            background: var(--primary);
            color: white;
            display: grid;
            grid-template-columns: 280px 1fr auto;
            align-items: center;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .topbar {
            background: #2d3748;
            border-bottom: 1px solid var(--border);
        }

        .topbar-logo {
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            white-space: nowrap;
            transition: opacity 0.2s;
            padding: 0 1.5rem;
        }
        .topbar-logo:hover { opacity: 0.8; }

        .topbar-search {
            width: 100%;
            position: relative;
            padding: 0 1rem;
        }

        .topbar-search input {
            width: 100%;
            height: 36px;
            padding: 0 4rem 0 2.25rem;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 0.9rem;
            outline: none;
            transition: background 0.2s;
        }

        .topbar-search input::placeholder { color: rgba(255,255,255,0.6); }
        .topbar-search input:focus { background: rgba(255,255,255,0.25); }

        [data-theme="dark"] .topbar-search input {
            background: rgba(0,0,0,0.3);
        }
        [data-theme="dark"] .topbar-search input:focus {
            background: rgba(0,0,0,0.4);
        }

        .search-icon {
            position: absolute;
            left: 1.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.5);
            pointer-events: none;
            display: flex;
            align-items: center;
        }
        .search-icon svg {
            width: 14px;
            height: 14px;
        }

        .search-hint {
            position: absolute;
            right: 1.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.65rem;
            color: rgba(255,255,255,0.5);
            pointer-events: none;
            background: rgba(255,255,255,0.15);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-family: -apple-system, system-ui, sans-serif;
        }

        .search-clear {
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }
        .search-clear.visible { display: flex; }
        .search-clear:hover { background: rgba(255,255,255,0.5); }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-right: 1.5rem;
        }

        .topbar-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            height: 36px;
            padding: 0 0.75rem;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .topbar-btn:hover { background: rgba(255,255,255,0.2); }
        .topbar-btn.icon-only { padding: 0 0.6rem; }
        .topbar-btn.icon-only span { display: flex; align-items: center; }
        .topbar-btn.icon-only svg { width: 16px; height: 16px; }

        /* App Body */
        .app-body {
            display: flex;
            margin-top: var(--topbar-height);
            min-height: calc(100vh - var(--topbar-height));
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-paper);
            border-right: 1px solid var(--border);
            position: fixed;
            top: var(--topbar-height);
            bottom: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .recent-item, .fav-item {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.5rem;
            font-size: 0.8rem;
            color: var(--text);
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.1s;
        }
        .recent-item:hover, .fav-item:hover {
            background: var(--bg);
            color: var(--accent);
        }

        .nav-controls {
            display: flex;
            justify-content: flex-end;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .nav-toggle-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.65rem;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.15s;
        }

        .nav-toggle-btn:hover {
            background: var(--bg);
            color: var(--text);
            border-color: var(--text-light);
        }

        .nav-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .sidebar-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .sidebar-footer-title {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .shortcuts {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.25rem 0.75rem;
            font-size: 0.75rem;
        }

        .shortcuts kbd {
            background: var(--bg-paper);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.1rem 0.4rem;
            font-family: -apple-system, system-ui, sans-serif;
            font-size: 0.65rem;
            color: var(--text-light);
        }

        .shortcuts span {
            color: var(--text-light);
        }

        .nav-section { margin-bottom: 0.25rem; }

        .nav-section-header {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            user-select: none;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            font-weight: 600;
            transition: background 0.1s;
        }
        .nav-section-header:hover { background: var(--bg); }
        .nav-section-header .icon { margin-right: 0.5rem; display: inline-flex; align-items: center; }
        .nav-section-header .icon svg { vertical-align: middle; }
        .nav-section-header .name { flex: 1; }
        .nav-section-header .count {
            background: var(--bg);
            padding: 0.1rem 0.4rem;
            border-radius: 8px;
            font-size: 0.65rem;
            margin-right: 0.5rem;
        }
        .nav-section-header .chevron {
            display: flex;
            align-items: center;
            transition: transform 0.2s;
        }
        .nav-section-header .chevron svg { width: 10px; height: 10px; }
        .nav-section.collapsed .chevron { transform: rotate(-90deg); }
        .nav-section.collapsed .nav-items { display: none; }

        .nav-items { padding-bottom: 0.25rem; }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem 0.5rem 2.25rem;
            font-size: 0.85rem;
            color: var(--text);
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.1s;
        }
        .nav-item:hover {
            background: var(--bg);
            color: var(--accent);
        }
        .nav-item.active {
            background: rgba(74, 111, 165, 0.1);
            color: var(--accent);
            border-left-color: var(--accent);
            font-weight: 500;
        }
        .nav-item.hidden { display: none; }

        .nav-item-text { flex: 1; }
        .nav-item .subtitle {
            font-size: 0.7rem;
            color: var(--text-light);
            display: block;
        }

        .nav-item .star {
            opacity: 0;
            color: var(--text-light);
            cursor: pointer;
            padding: 0.25rem;
            transition: opacity 0.1s;
        }
        .nav-item:hover .star { opacity: 0.5; }
        .nav-item .star:hover { opacity: 1; color: #ecc94b; }
        .nav-item .star.active { opacity: 1; color: #ecc94b; }

        /* Main Content */
        .main {
            flex: 1;
            margin-left: 280px;
            padding: 1.5rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .breadcrumb,
        .doc-meta,
        .content {
            max-width: 900px;
            width: 100%;
        }

        /* Progress Bar */
        .progress-bar {
            position: fixed;
            top: var(--topbar-height);
            left: 280px;
            right: 0;
            height: 3px;
            background: var(--border);
            z-index: 50;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.1s;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
        }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb .separator { opacity: 0.5; }

        /* Document Meta */
        .doc-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .badge-low { background: rgba(56, 161, 105, 0.15); color: var(--success); }
        .badge-moderate { background: rgba(214, 158, 46, 0.15); color: var(--warning); }
        .badge-high { background: rgba(229, 62, 62, 0.15); color: var(--danger); }
        .badge-fda { background: rgba(74, 111, 165, 0.15); color: var(--accent); }
        .badge-neutral { background: var(--bg); color: var(--text-light); }

        /* Content */
        .content {
            background: var(--bg-paper);
            padding: 2rem 2.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        /* Welcome */
        .welcome { text-align: center; padding: 2rem 1rem; }
        .welcome h1 {
            font-size: 1.75rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
            border: none;
        }
        .welcome-subtitle { color: var(--text-light); margin-bottom: 2rem; }

        .welcome-main-choices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .main-choice {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 2rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .main-choice:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        .main-choice-icon {
            color: var(--accent);
            margin-bottom: 0.75rem;
        }
        .main-choice-icon svg { width: 32px; height: 32px; }
        .main-choice h2 {
            font-size: 1.25rem;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }
        .main-choice p {
            font-size: 0.85rem;
            color: var(--text-light);
            margin: 0;
        }

        .welcome-recent {
            margin-top: 2rem;
            text-align: left;
        }
        .welcome-recent h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }
        .welcome-recent-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        @media (max-width: 500px) {
            .welcome-main-choices { grid-template-columns: 1fr; }
            .welcome-recent-items { grid-template-columns: 1fr; }
            .main-choice { padding: 1.5rem 1rem; }
        }

        .welcome-section { margin-bottom: 0.5rem; }
        .welcome-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 0.75rem;
        }

        .welcome-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }
        .welcome-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .welcome-card h4 {
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 0.15rem;
        }
        .welcome-card p {
            font-size: 0.75rem;
            color: var(--text-light);
            margin: 0;
        }

        .welcome-empty {
            color: var(--text-light);
            font-size: 0.85rem;
            font-style: italic;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
        }

        .welcome-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 2rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .category-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .category-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .category-card .icon {
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: center;
            color: var(--accent);
        }
        .category-card .icon svg {
            width: 20px;
            height: 20px;
        }

        .category-card .name {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text);
        }

        .category-card .count {
            font-size: 0.7rem;
            color: var(--text-light);
        }

        /* Category listing page */
        .category-page { padding: 1rem 0; }
        .category-page h1 {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.25rem;
            border: none;
            padding: 0;
        }
        .category-page .category-count {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        .category-page .category-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        @media (max-width: 600px) {
            .category-page .category-items { grid-template-columns: 1fr; }
        }

        .category-tag {
            display: inline-block;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.15rem 0.5rem;
            font-size: 0.75rem;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.15s;
            margin-right: 0.25rem;
        }

        .category-tag:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Markdown Styles */
        .content h1 {
            font-size: 1.6rem;
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--accent);
        }
        .content h2 {
            font-size: 1.25rem;
            color: var(--primary);
            margin: 2rem 0 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        .content h3 { font-size: 1.05rem; color: var(--text); margin: 1.5rem 0 0.5rem; }
        .content p { margin-bottom: 1rem; line-height: 1.8; }
        .content ul, .content ol { margin: 1rem 0 1.5rem 1.5rem; }
        .content li { margin-bottom: 0.4rem; }
        .content strong { color: var(--primary); }
        .content blockquote {
            border-left: 4px solid var(--accent);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--bg);
            border-radius: 0 8px 8px 0;
        }
        .content code {
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.85em;
            background: var(--bg);
            padding: 0.2em 0.4em;
            border-radius: 4px;
        }
        .content pre {
            background: #1a1a2e;
            color: #e2e8f0;
            padding: 1.25rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1.5rem 0;
        }
        .content pre code { background: none; padding: 0; color: inherit; }
        .content hr { border: none; height: 1px; background: var(--border); margin: 2rem 0; }
        .content table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; font-size: 0.9rem; }
        .content th {
            background: var(--primary);
            color: white;
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-weight: 500;
            font-size: 0.8rem;
        }
        [data-theme="dark"] .content th { background: #4a5568; }
        .content td { padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); }
        .content tr:hover { background: var(--bg); }
        .content a { color: var(--accent); }

        /* Mermaid Diagrams */
        .content .mermaid {
            background: var(--bg);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            overflow-x: auto;
            text-align: center;
        }
        .content .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        /* Mermaid custom styling */
        .content .mermaid .node rect,
        .content .mermaid .node polygon,
        .content .mermaid .node circle {
            fill: var(--bg-paper) !important;
            stroke: var(--accent) !important;
            stroke-width: 2px !important;
        }
        .content .mermaid .node .label {
            color: var(--text) !important;
        }
        .content .mermaid .edgePath path {
            stroke: var(--accent) !important;
            stroke-width: 2px !important;
        }
        .content .mermaid .edgeLabel {
            background-color: var(--bg) !important;
            color: var(--text-light) !important;
        }
        .content .mermaid .marker {
            fill: var(--accent) !important;
            stroke: var(--accent) !important;
        }

        /* Document Navigation */
        .doc-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }
        .doc-nav-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .doc-nav-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .doc-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .doc-nav-btn:disabled:hover {
            border-color: var(--border);
            color: var(--text);
        }

        .no-results {
            padding: 1rem;
            text-align: center;
            color: var(--text-light);
            font-size: 0.85rem;
        }
        .no-results a { color: var(--accent); cursor: pointer; }

        /* Keyboard hints */
        .kbd {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            font-size: 0.65rem;
            font-family: monospace;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
        }
        .mobile-menu-btn svg { width: 20px; height: 20px; }

        /* Mobile search button */
        .mobile-search-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
        }
        .mobile-search-btn svg { width: 18px; height: 18px; }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 150;
        }
        .sidebar-overlay.visible { display: block; }

        /* Mobile search overlay */
        .mobile-search-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: var(--primary);
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        [data-theme="dark"] .mobile-search-overlay { background: #2d3748; }
        .mobile-search-overlay.visible { display: block; }
        .mobile-search-overlay input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255,255,255,0.15);
            color: white;
            outline: none;
        }
        .mobile-search-overlay input::placeholder { color: rgba(255,255,255,0.6); }
        .mobile-search-close {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .topbar { grid-template-columns: 240px 1fr auto; }
            .sidebar { width: 240px; }
            .main { margin-left: 240px; padding: 1.5rem; }
            .progress-bar { left: 240px; }
        }

        @media (max-width: 700px) {
            .topbar {
                grid-template-columns: auto 1fr auto;
                padding: 0 0.75rem;
            }
            .topbar-logo {
                padding: 0 0.5rem;
                font-size: 1rem;
            }
            .mobile-menu-btn { display: flex; align-items: center; }
            .mobile-search-btn { display: flex; align-items: center; }
            .topbar-search { display: none; }
            .topbar-actions { padding-right: 0; gap: 0.25rem; }
            .topbar-btn.icon-only { padding: 0 0.5rem; }

            .sidebar {
                position: fixed;
                left: -280px;
                width: 280px;
                top: 0;
                bottom: 0;
                z-index: 160;
                transition: left 0.3s ease;
            }
            .sidebar.open { left: 0; }

            .main { margin-left: 0; padding: 0.75rem; }
            .progress-bar { left: 0; }
            .content { padding: 1.25rem; }
            .content h1 { font-size: 1.3rem; }
            .content h2 { font-size: 1.1rem; }
            .breadcrumb { font-size: 0.8rem; }
            .welcome h1 { font-size: 1.4rem; }
            .welcome-sections { grid-template-columns: 1fr; }
            .welcome-categories { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
            .category-card { padding: 0.6rem 0.75rem; }
            .sidebar-footer { display: none; }
        }
    </style>
</head>
<body>
    <!-- Password -->
    <div class="password-screen" id="passwordScreen">
        <div class="password-box">
            <h1>Ducu & Bo' Peptides</h1>
            <p>Enter password to access</p>
            <input type="password" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Enter</button>
            <p class="error-msg" id="errorMsg">Incorrect password</p>
        </div>
    </div>

    <!-- App -->
    <div class="app" id="app">
        <!-- Mobile overlays -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>
        <div class="mobile-search-overlay" id="mobileSearchOverlay">
            <input type="text" id="mobileSearchInput" placeholder="Search peptides..." oninput="handleSearch(this.value)">
            <button class="mobile-search-close" onclick="closeMobileSearch()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>

        <!-- Top Bar -->
        <header class="topbar">
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
            <div class="topbar-logo" onclick="showWelcome()"><svg width="24" height="24" viewBox="0 0 32 32" style="vertical-align:middle;margin-right:0.5rem"><rect width="32" height="32" rx="6" fill="#4a6fa5"/><circle cx="10" cy="16" r="4" fill="white"/><circle cx="22" cy="10" r="3" fill="white"/><circle cx="22" cy="22" r="3" fill="white"/><line x1="13" y1="14" x2="19" y2="11" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="13" y1="18" x2="19" y2="21" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>Ducu & Bo'</div>
            <div class="topbar-search">
                <span class="search-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
                <input type="text" id="searchInput" placeholder="Search peptides..." oninput="handleSearch(this.value)">
                <span class="search-hint" id="searchHint">Ctrl+K</span>
                <button class="search-clear" id="searchClear" onclick="clearSearch()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="topbar-actions">
                <button class="mobile-search-btn" onclick="openMobileSearch()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                </button>
                <button class="topbar-btn icon-only" onclick="toggleDarkMode()" id="darkModeBtn" title="Toggle dark mode (D)">
                    <span id="darkModeIcon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg></span>
                </button>
                <button class="topbar-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="app-body">
            <!-- Progress Bar -->
            <div class="progress-bar" id="progressBar">
                <div class="progress-bar-fill" id="progressFill"></div>
            </div>

            <!-- Sidebar -->
            <nav class="sidebar">
                <div class="sidebar-section" id="recentSection" style="display:none;">
                    <div class="sidebar-section-title">Recently Viewed</div>
                    <div id="recentList"></div>
                </div>

                <div class="sidebar-section" id="favSection" style="display:none;">
                    <div class="sidebar-section-title">Favorites</div>
                    <div id="favList"></div>
                </div>

                <div class="nav-controls">
                    <button class="nav-toggle-btn" id="navToggleBtn" onclick="toggleAllSections()">Collapse all</button>
                </div>

                <div class="nav-scroll" id="navScroll"></div>

                <div class="sidebar-footer">
                    <div class="sidebar-footer-title">Keyboard Shortcuts</div>
                    <div class="shortcuts">
                        <kbd id="searchKey">/</kbd> <span>Search</span>
                        <kbd>H</kbd> <span>Home</span>
                        <kbd>D</kbd> <span>Dark mode</span>
                        <kbd><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle"><polyline points="15 18 9 12 15 6"/></svg><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle"><polyline points="9 18 15 12 9 6"/></svg></kbd> <span>Prev / Next</span>
                    </div>
                </div>
            </nav>

            <!-- Main -->
            <main class="main" id="mainArea">
                <div class="breadcrumb" id="breadcrumb"></div>
                <div class="doc-meta" id="docMeta"></div>
                <div class="content" id="content"></div>
            </main>
        </div>
    </div>

    <script>
        const PASS = 'limitless';
        const STORAGE_RECENT = 'peptides_recent';
        const STORAGE_FAV = 'peptides_favorites';
        const STORAGE_DARK = 'peptides_darkmode';

        // Categories
        const categories = {
            protocols: { name: 'Protocols', icon: 'Doc', files: [
                { file: 'protocols/titan-protocol.md', name: 'TITAN Protocol', subtitle: 'Complete longevity protocol' },
                { file: 'protocols/athena-protocol.md', name: 'ATHENA Protocol', subtitle: 'Women\'s health & hormones' },
                { file: 'protocols/prometheus-protocol.md', name: 'PROMETHEUS Protocol', subtitle: 'Aggressive age reversal' }
            ]},
            gh_metabolic: { name: 'GH Axis & Metabolic', icon: 'Bolt', files: [
                { file: 'peptides/tesamorelin-research.md', name: 'Tesamorelin', subtitle: 'FDA approved GHRH' },
                { file: 'peptides/ipamorelin-research.md', name: 'Ipamorelin', subtitle: 'Selective GH secretagogue' },
                { file: 'peptides/cjc-1295-research.md', name: 'CJC-1295', subtitle: 'GHRH analog' },
                { file: 'peptides/igf-1-lr3-research.md', name: 'IGF-1 LR3', subtitle: 'Long-acting IGF-1' },
                { file: 'peptides/follistatin-344-research.md', name: 'Follistatin-344', subtitle: 'Myostatin inhibitor' },
                { file: 'peptides/semaglutide-research.md', name: 'Semaglutide', subtitle: 'GLP-1 (Ozempic)' },
                { file: 'peptides/tirzepatide-research.md', name: 'Tirzepatide', subtitle: 'GIP/GLP-1 (Mounjaro)' },
                { file: 'peptides/retatrutide-research.md', name: 'Retatrutide', subtitle: 'Triple agonist' },
                { file: 'peptides/aod-9604-research.md', name: 'AOD-9604', subtitle: 'HGH fragment' },
                { file: 'peptides/adipotide-research.md', name: 'Adipotide', subtitle: 'Fat-targeting' }
            ]},
            tissue: { name: 'Tissue Repair', icon: 'Band', files: [
                { file: 'peptides/bpc-157-research.md', name: 'BPC-157', subtitle: 'Body protection compound' },
                { file: 'peptides/tb-500-research.md', name: 'TB-500', subtitle: 'Thymosin Beta-4' },
                { file: 'peptides/ghk-cu-research.md', name: 'GHK-Cu', subtitle: 'Copper peptide' },
                { file: 'peptides/teriparatide-research.md', name: 'Teriparatide', subtitle: 'PTH for bone' }
            ]},
            cognitive: { name: 'Cognitive', icon: 'Brain', files: [
                { file: 'peptides/semax-research.md', name: 'Semax', subtitle: 'Nootropic' },
                { file: 'peptides/selank-research.md', name: 'Selank', subtitle: 'Anxiolytic' },
                { file: 'peptides/dihexa-research.md', name: 'Dihexa', subtitle: 'HGF mimetic (caution)' },
                { file: 'peptides/phdp5-research.md', name: 'PHDP-5', subtitle: 'Cognitive peptide' }
            ]},
            immune: { name: 'Immune & Thymus', icon: 'Shield', files: [
                { file: 'peptides/thymalin-research.md', name: 'Thymalin', subtitle: 'Thymic peptide' },
                { file: 'peptides/thymosin-alpha-1-research.md', name: 'Thymosin Alpha-1', subtitle: 'Immune modulator' },
                { file: 'peptides/thymogen-research.md', name: 'Thymogen', subtitle: 'Thymic dipeptide' },
                { file: 'peptides/kpv-research.md', name: 'KPV', subtitle: 'Anti-inflammatory' },
                { file: 'peptides/gcmaf-research.md', name: 'GcMAF', subtitle: 'Macrophage activator' },
                { file: 'peptides/cecropins-research.md', name: 'Cecropins', subtitle: 'Antimicrobial' }
            ]},
            longevity: { name: 'Longevity', icon: 'Hour', files: [
                { file: 'peptides/epitalon-research.md', name: 'Epitalon', subtitle: 'Telomerase activator' },
                { file: 'peptides/mots-c-research.md', name: 'MOTS-c', subtitle: 'Mitochondrial peptide' },
                { file: 'peptides/humanin-research.md', name: 'Humanin', subtitle: 'Cytoprotective' },
                { file: 'peptides/ss-31-research.md', name: 'SS-31', subtitle: 'Mitochondrial protector' },
                { file: 'peptides/nad-research.md', name: 'NAD+', subtitle: 'Cellular energy' }
            ]},
            sexual: { name: 'Sexual & Hormonal', icon: 'Heart', files: [
                { file: 'peptides/pt-141-research.md', name: 'PT-141', subtitle: 'Sexual function' },
                { file: 'peptides/melanotan-2-research.md', name: 'Melanotan II', subtitle: 'Tanning & libido' },
                { file: 'peptides/kisspeptin-research.md', name: 'Kisspeptin', subtitle: 'GnRH regulator' },
                { file: 'peptides/oxytocin-research.md', name: 'Oxytocin', subtitle: 'Bonding hormone' }
            ]},
            sleep: { name: 'Sleep', icon: 'Moon', files: [
                { file: 'peptides/dsip-research.md', name: 'DSIP', subtitle: 'Sleep-inducing' },
                { file: 'peptides/vip-research.md', name: 'VIP', subtitle: 'Vasoactive peptide' }
            ]},
            organ: { name: 'Organ-Specific', icon: 'Organ', files: [
                { file: 'peptides/cardiogen-research.md', name: 'Cardiogen', subtitle: 'Cardiac' },
                { file: 'peptides/bronchogen-research.md', name: 'Bronchogen', subtitle: 'Lung' },
                { file: 'peptides/prostamax-research.md', name: 'Prostamax', subtitle: 'Prostate' },
                { file: 'peptides/nk-peptide-research.md', name: 'NK Peptide', subtitle: 'Kidney' },
                { file: 'peptides/melittin-research.md', name: 'Melittin', subtitle: 'Bee venom' }
            ]}
        };

        let currentFile = null;
        let currentMarkdown = '';

        // Count totals
        const totalPeptides = Object.values(categories).reduce((sum, cat) =>
            cat.name !== 'Protocols' ? sum + cat.files.length : sum, 0);
        const totalCategories = Object.keys(categories).length - 1; // exclude Protocols
        const totalProtocols = categories.protocols.files.length;

        // Auth
        function checkPassword() {
            const input = document.getElementById('passwordInput');
            if (input.value === PASS) {
                sessionStorage.setItem('auth', '1');
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('app').classList.add('visible');
                init();
            } else {
                input.classList.add('error');
                document.getElementById('errorMsg').classList.add('visible');
                setTimeout(() => input.classList.remove('error'), 500);
            }
        }

        function logout() {
            sessionStorage.removeItem('auth');
            window.location.reload();
        }

        // Mobile Menu
        function toggleMobileMenu() {
            document.querySelector('.sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('visible');
        }

        function closeMobileMenu() {
            document.querySelector('.sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('visible');
        }

        function openMobileSearch() {
            document.getElementById('mobileSearchOverlay').classList.add('visible');
            document.getElementById('mobileSearchInput').focus();
        }

        function closeMobileSearch() {
            document.getElementById('mobileSearchOverlay').classList.remove('visible');
            document.getElementById('mobileSearchInput').value = '';
            clearSearch();
        }

        // Dark Mode
        function initDarkMode() {
            const stored = localStorage.getItem(STORAGE_DARK);
            if (stored === 'true' || (stored === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
                updateDarkModeIcon(true);
            }
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem(STORAGE_DARK, 'false');
                updateDarkModeIcon(false);
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem(STORAGE_DARK, 'true');
                updateDarkModeIcon(true);
            }
        }

        function updateDarkModeIcon(isDark) {
            const moonSvg = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>';
            const sunSvg = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>';
            document.getElementById('darkModeIcon').innerHTML = isDark ? sunSvg : moonSvg;
        }

        // Recently Viewed
        function getRecent() {
            try { return JSON.parse(localStorage.getItem(STORAGE_RECENT)) || []; }
            catch { return []; }
        }

        function addRecent(file) {
            let recent = getRecent().filter(f => f !== file);
            recent.unshift(file);
            recent = recent.slice(0, 5);
            localStorage.setItem(STORAGE_RECENT, JSON.stringify(recent));
            renderRecent();
        }

        function renderRecent() {
            const recent = getRecent();
            const section = document.getElementById('recentSection');
            const list = document.getElementById('recentList');

            if (recent.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = recent.map(file => {
                const info = getFileInfo(file);
                return `<div class="recent-item" onclick="loadFile('${file}')">${info?.name || file}</div>`;
            }).join('');
        }

        // Favorites
        function getFavorites() {
            try { return JSON.parse(localStorage.getItem(STORAGE_FAV)) || []; }
            catch { return []; }
        }

        function toggleFavorite(file) {
            let favs = getFavorites();
            if (favs.includes(file)) {
                favs = favs.filter(f => f !== file);
            } else {
                favs.push(file);
            }
            localStorage.setItem(STORAGE_FAV, JSON.stringify(favs));
            renderFavorites();
            renderNav();
        }

        function renderFavorites() {
            const favs = getFavorites();
            const section = document.getElementById('favSection');
            const list = document.getElementById('favList');

            if (favs.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = favs.map(file => {
                const info = getFileInfo(file);
                return `<div class="fav-item" onclick="loadFile('${file}')">${info?.name || file}</div>`;
            }).join('');
        }

        function getFileInfo(file) {
            for (const cat of Object.values(categories)) {
                const found = cat.files.find(f => f.file === file);
                if (found) return found;
            }
            return null;
        }

        // Navigation
        function renderNav() {
            const favs = getFavorites();
            const nav = document.getElementById('navScroll');
            nav.innerHTML = Object.entries(categories).map(([key, cat]) => `
                <div class="nav-section" data-key="${key}">
                    <div class="nav-section-header" onclick="toggleSection('${key}')">
                        <span class="icon">${getIcon(cat.icon)}</span>
                        <span class="name">${cat.name}</span>
                        <span class="count">${cat.files.length}</span>
                        <span class="chevron"><svg viewBox="0 0 10 10" fill="currentColor"><polygon points="0,0 10,0 5,8"/></svg></span>
                    </div>
                    <div class="nav-items">
                        ${cat.files.map(f => `
                            <div class="nav-item ${currentFile === f.file ? 'active' : ''}" data-file="${f.file}" onclick="loadFile('${f.file}')">
                                <div class="nav-item-text">
                                    ${f.name}
                                    <span class="subtitle">${f.subtitle}</span>
                                </div>
                                <span class="star ${favs.includes(f.file) ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${f.file}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="${favs.includes(f.file) ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function getIcon(name) {
            const icons = {
                'Doc': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
                'Bolt': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
                'Band': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M8.5 8.5l-2 2a4.95 4.95 0 0 0 7 7l2-2"/><path d="M15.5 15.5l2-2a4.95 4.95 0 0 0-7-7l-2 2"/></svg>',
                'Brain': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M12 5v13"/></svg>',
                'Shield': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>',
                'Hour': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 22h14"/><path d="M5 2h14"/><path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/><path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/></svg>',
                'Heart': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>',
                'Moon': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>',
                'Organ': '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572"/><path d="M12 6l-2 4l4 2l-2 4"/></svg>'
            };
            return icons[name] || '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';
        }

        function toggleSection(key) {
            document.querySelector(`.nav-section[data-key="${key}"]`).classList.toggle('collapsed');
            updateToggleButton();
        }

        function toggleAllSections() {
            const sections = document.querySelectorAll('.nav-section');
            const allCollapsed = Array.from(sections).every(s => s.classList.contains('collapsed'));

            sections.forEach(section => {
                if (allCollapsed) {
                    section.classList.remove('collapsed');
                } else {
                    section.classList.add('collapsed');
                }
            });
            updateToggleButton();
        }

        function updateToggleButton() {
            const sections = document.querySelectorAll('.nav-section');
            const allCollapsed = Array.from(sections).every(s => s.classList.contains('collapsed'));
            document.getElementById('navToggleBtn').textContent = allCollapsed ? 'Expand all' : 'Collapse all';
        }

        function goToCategory(key) {
            // Show category listing page
            showCategoryPage(key);
        }

        function showCategoryPage(key) {
            closeMobileMenu();
            currentFile = null;
            currentMarkdown = '';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('docMeta').innerHTML = '';
            document.getElementById('progressBar').style.display = 'none';

            const cat = categories[key];
            if (!cat) return;

            // Update breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <a onclick="showWelcome()">Home</a>
                <span class="separator">/</span>
                <span>${cat.name}</span>
            `;

            // Build items list
            const itemsHtml = cat.files.map(f => `
                <div class="welcome-card" onclick="loadFile('${f.file}')">
                    <h4>${f.name}</h4>
                    <p>${f.subtitle}</p>
                </div>
            `).join('');

            document.getElementById('content').innerHTML = `
                <div class="category-page">
                    <h1>${cat.name}</h1>
                    <p class="category-count">${cat.files.length} ${cat.files.length === 1 ? 'item' : 'items'}</p>
                    <div class="category-items">
                        ${itemsHtml}
                    </div>
                </div>
            `;

            // Expand this category in sidebar
            const section = document.querySelector(`.nav-section[data-key="${key}"]`);
            if (section) section.classList.remove('collapsed');
            updateToggleButton();

            history.pushState({ category: key }, '', `#category/${key}`);
        }

        function showAllPeptides() {
            closeMobileMenu();
            currentFile = null;
            currentMarkdown = '';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('docMeta').innerHTML = '';
            document.getElementById('progressBar').style.display = 'none';

            document.getElementById('breadcrumb').innerHTML = `
                <a onclick="showWelcome()">Home</a>
                <span class="separator">/</span>
                <span>Peptides</span>
            `;

            // Build categories (exclude protocols)
            const peptideCategories = Object.entries(categories)
                .filter(([key]) => key !== 'protocols')
                .map(([key, cat]) => `
                    <div class="category-card" onclick="goToCategory('${key}')">
                        <div class="icon">${getIcon(cat.icon)}</div>
                        <div class="name">${cat.name}</div>
                        <div class="count">${cat.files.length} ${cat.files.length === 1 ? 'item' : 'items'}</div>
                    </div>
                `).join('');

            document.getElementById('content').innerHTML = `
                <div class="category-page">
                    <h1>Peptides</h1>
                    <p class="category-count">${totalPeptides} peptides across ${totalCategories} categories</p>
                    <div class="welcome-categories" style="margin-top:1rem;">
                        ${peptideCategories}
                    </div>
                </div>
            `;

            history.pushState({ peptides: true }, '', '#peptides');
        }

        // Progress Bar
        function updateProgress() {
            if (!currentFile) {
                document.getElementById('progressBar').style.display = 'none';
                return;
            }
            document.getElementById('progressBar').style.display = 'block';

            const main = document.getElementById('mainArea');
            const scrollTop = main.scrollTop || window.scrollY;
            const scrollHeight = main.scrollHeight - main.clientHeight || document.body.scrollHeight - window.innerHeight;
            const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
            document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
        }

        // Load File
        async function loadFile(filePath, pushState = true) {
            closeMobileMenu(); // Close mobile nav if open
            currentFile = filePath;
            addRecent(filePath);

            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.file === filePath);
            });

            // Get file info
            let catName = '', fileName = '', catKey = '';
            for (const [key, cat] of Object.entries(categories)) {
                const found = cat.files.find(f => f.file === filePath);
                if (found) {
                    catName = cat.name;
                    fileName = found.name;
                    catKey = key;
                    break;
                }
            }

            // Update breadcrumb
            document.getElementById('breadcrumb').innerHTML = `
                <a onclick="showWelcome()">Home</a>
                <span class="separator">/</span>
                <a onclick="goToCategory('${catKey}')">${catName}</a>
                <span class="separator">/</span>
                <span>${fileName}</span>
            `;

            // Load content
            const content = document.getElementById('content');
            const docMeta = document.getElementById('docMeta');
            content.innerHTML = '<p style="color:var(--text-light);padding:2rem;text-align:center;">Loading...</p>';
            docMeta.innerHTML = '';

            try {
                const res = await fetch(filePath);
                if (!res.ok) throw new Error();
                currentMarkdown = await res.text();

                // Parse metadata from markdown
                const badges = parseMetadata(currentMarkdown);
                const readTime = Math.ceil(currentMarkdown.split(/\s+/).length / 200);

                // Render metadata badges
                docMeta.innerHTML = badges + `<span class="badge badge-neutral">${readTime} min read</span>`;

                // Render content
                content.innerHTML = marked.parse(currentMarkdown);

                // Make category tags clickable
                makeCategoryTagsClickable();

                // Render mermaid diagrams
                await renderMermaid();

                // Add navigation
                addDocNav(catKey, filePath);

                window.scrollTo(0, 0);
                updateProgress();
            } catch {
                content.innerHTML = `<p style="color:var(--danger);padding:2rem;">Could not load ${filePath}</p>`;
            }

            if (pushState) {
                history.pushState({ file: filePath }, '', `#${encodeURIComponent(filePath)}`);
            }
        }

        function parseMetadata(md) {
            let badges = '';

            // Risk level
            const riskMatch = md.match(/\*\*Risk Profile:\*\*\s*([^\n]+)/i);
            if (riskMatch) {
                const risk = riskMatch[1].toUpperCase();
                if (risk.includes('HIGH')) {
                    badges += '<span class="badge badge-high">HIGH RISK</span>';
                } else if (risk.includes('MODERATE')) {
                    badges += '<span class="badge badge-moderate">' + (risk.includes('LOW') ? 'LOW-MODERATE' : 'MODERATE') + '</span>';
                } else if (risk.includes('LOW')) {
                    badges += '<span class="badge badge-low">LOW RISK</span>';
                }
            }

            // Evidence level
            const evidenceMatch = md.match(/\*\*(?:Evidence Level|OCEBM Evidence Level):\*\*\s*([^\n]+)/i);
            if (evidenceMatch) {
                const evidence = evidenceMatch[1];
                if (evidence.toLowerCase().includes('fda')) {
                    badges += '<span class="badge badge-fda">FDA Approved</span>';
                } else if (evidence.toLowerCase().includes('phase')) {
                    const phase = evidence.match(/phase\s*(\w+)/i);
                    if (phase) badges += `<span class="badge badge-neutral">Phase ${phase[1]}</span>`;
                }
            }

            return badges;
        }

        function addDocNav(catKey, currentFile) {
            const cat = categories[catKey];
            if (!cat) return;

            const files = cat.files;
            const currentIndex = files.findIndex(f => f.file === currentFile);
            const prev = currentIndex > 0 ? files[currentIndex - 1] : null;
            const next = currentIndex < files.length - 1 ? files[currentIndex + 1] : null;

            const content = document.getElementById('content');
            content.innerHTML += `
                <div class="doc-nav">
                    <button class="doc-nav-btn" ${prev ? `onclick="loadFile('${prev.file}')"` : 'disabled'}>
                        < ${prev ? prev.name : 'Previous'}
                    </button>
                    <button class="doc-nav-btn" ${next ? `onclick="loadFile('${next.file}')"` : 'disabled'}>
                        ${next ? next.name : 'Next'} >
                    </button>
                </div>
            `;
        }

        // Welcome Screen
        function showWelcome() {
            closeMobileMenu(); // Close mobile nav if open
            currentFile = null;
            currentMarkdown = '';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('breadcrumb').innerHTML = '';
            document.getElementById('docMeta').innerHTML = '';
            document.getElementById('progressBar').style.display = 'none';

            const recent = getRecent();
            const favs = getFavorites();

            // Use text-based icons (no emojis)

            document.getElementById('content').innerHTML = `
                <div class="welcome">
                    <h1>Ducu & Bo' Peptides</h1>
                    <p class="welcome-subtitle">Research documentation</p>

                    <div class="welcome-main-choices">
                        <div class="main-choice" onclick="goToCategory('protocols')">
                            <div class="main-choice-icon">${getIcon('Doc')}</div>
                            <h2>Protocols</h2>
                            <p>${totalProtocols} complete protocols</p>
                        </div>
                        <div class="main-choice" onclick="showAllPeptides()">
                            <div class="main-choice-icon">${getIcon('Bolt')}</div>
                            <h2>Peptides</h2>
                            <p>${totalPeptides} peptides across ${totalCategories} categories</p>
                        </div>
                    </div>

                    ${recent.length > 0 ? `
                        <div class="welcome-recent">
                            <h3>Continue Reading</h3>
                            <div class="welcome-recent-items">
                                ${recent.slice(0, 4).map(file => {
                                    const info = getFileInfo(file);
                                    return info ? `
                                        <div class="welcome-card" onclick="loadFile('${file}')">
                                            <h4>${info.name}</h4>
                                            <p>${info.subtitle}</p>
                                        </div>
                                    ` : '';
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            history.pushState({}, '', window.location.pathname);
        }

        // Search
        function handleSearch(query) {
            const q = query.toLowerCase().trim();
            const clearBtn = document.getElementById('searchClear');
            const hint = document.getElementById('searchHint');

            clearBtn.classList.toggle('visible', q.length > 0);
            hint.style.display = q.length > 0 ? 'none' : 'block';

            document.querySelectorAll('.nav-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.classList.toggle('hidden', q && !text.includes(q));
            });

            document.querySelectorAll('.nav-section').forEach(section => {
                const hasVisible = section.querySelectorAll('.nav-item:not(.hidden)').length > 0;
                section.style.display = hasVisible ? '' : 'none';
                if (q && hasVisible) section.classList.remove('collapsed');
            });

            // No results
            const nav = document.getElementById('navScroll');
            const existing = nav.querySelector('.no-results');
            if (existing) existing.remove();

            if (q && !document.querySelector('.nav-item:not(.hidden)')) {
                nav.innerHTML += `<div class="no-results">No results for "${q}"<br><a onclick="clearSearch()">Clear search</a></div>`;
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchClear').classList.remove('visible');
            document.getElementById('searchHint').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('hidden'));
            document.querySelectorAll('.nav-section').forEach(s => s.style.display = '');
            const nr = document.querySelector('.no-results');
            if (nr) nr.remove();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            // Don't trigger when typing in input
            if (document.activeElement.tagName === 'INPUT') {
                if (e.key === 'Escape') {
                    clearSearch();
                    document.getElementById('searchInput').blur();
                }
                return;
            }

            // Ctrl+K or / for search
            if ((e.key === 'k' && (e.metaKey || e.ctrlKey)) || e.key === '/') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }

            // H for home
            if (e.key === 'h' || e.key === 'H') {
                e.preventDefault();
                showWelcome();
            }

            // D for dark mode
            if (e.key === 'd' || e.key === 'D') {
                e.preventDefault();
                toggleDarkMode();
            }

            // Arrow keys for prev/next
            if (currentFile && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                const btns = document.querySelectorAll('.doc-nav-btn:not([disabled])');
                if (e.key === 'ArrowLeft' && btns[0]) btns[0].click();
                if (e.key === 'ArrowRight' && btns[1]) btns[1].click();
            }

            // Escape to clear
            if (e.key === 'Escape') {
                clearSearch();
            }
        });

        // Category tag mapping for markdown content
        // Maps all tags found in MD files to sidebar categories
        const categoryTagMap = {
            // GH Axis & Metabolic
            'GH Axis': 'gh_metabolic',
            'Metabolic': 'gh_metabolic',
            'Metabolic / Fat Loss': 'gh_metabolic',
            'Fat Loss': 'gh_metabolic',
            'Muscle & Performance': 'gh_metabolic',
            // Tissue Repair
            'Tissue Repair': 'tissue',
            'Healing': 'tissue',
            'Bone & Joint': 'tissue',
            'Skin & Collagen': 'tissue',
            // Cognitive
            'Cognitive': 'cognitive',
            'Nootropic': 'cognitive',
            'Mood & Stress': 'cognitive',
            // Immune
            'Immune': 'immune',
            'Immune & Thymus': 'immune',
            'Thymus': 'immune',
            'Gut Health': 'immune',
            // Longevity
            'Longevity': 'longevity',
            'Anti-Aging': 'longevity',
            // Sexual & Hormonal
            'Sexual': 'sexual',
            'Sexual & Hormonal': 'sexual',
            'Hormonal': 'sexual',
            'Sexual Function': 'sexual',
            'Fertility & Hormones': 'sexual',
            // Sleep
            'Sleep': 'sleep',
            // Organ-Specific
            'Organ-Specific': 'organ',
            'Cardiac': 'organ',
            'Cardiovascular': 'organ',
            // Protocols
            'Protocols': 'protocols'
        };

        function makeCategoryTagsClickable() {
            // Find paragraphs that contain category tags (backticks with  separators)
            const content = document.getElementById('content');
            const paragraphs = content.querySelectorAll('p');

            paragraphs.forEach(p => {
                // Check if this looks like a categories line
                if (p.innerHTML.includes('<code>') && p.innerHTML.includes('')) {
                    const codes = p.querySelectorAll('code');
                    codes.forEach(code => {
                        const tagText = code.textContent.trim();
                        const catKey = categoryTagMap[tagText];
                        if (catKey) {
                            const span = document.createElement('span');
                            span.className = 'category-tag';
                            span.textContent = tagText;
                            span.onclick = () => goToCategory(catKey);
                            code.replaceWith(span);
                        }
                    });
                }
            });
        }

        // Mermaid rendering
        async function renderMermaid() {
            const codeBlocks = document.querySelectorAll('pre code.language-mermaid');
            for (const block of codeBlocks) {
                const code = block.textContent;
                const pre = block.parentElement;
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.textContent = code;
                pre.replaceWith(div);
            }
            if (codeBlocks.length > 0) {
                await mermaid.run();
            }
        }

        // Init
        function init() {
            initDarkMode();
            marked.setOptions({ breaks: true, gfm: true });
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            mermaid.initialize({
                startOnLoad: false,
                theme: 'base',
                themeVariables: isDark ? {
                    primaryColor: '#4a5568',
                    primaryTextColor: '#e2e8f0',
                    primaryBorderColor: '#63b3ed',
                    lineColor: '#63b3ed',
                    secondaryColor: '#2d3748',
                    tertiaryColor: '#1a202c',
                    background: '#2d3748',
                    mainBkg: '#2d3748',
                    nodeBorder: '#63b3ed',
                    clusterBkg: '#1a202c',
                    edgeLabelBackground: '#2d3748',
                    fontFamily: '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif'
                } : {
                    primaryColor: '#f7fafc',
                    primaryTextColor: '#2d3748',
                    primaryBorderColor: '#4a6fa5',
                    lineColor: '#4a6fa5',
                    secondaryColor: '#e2e8f0',
                    tertiaryColor: '#f7fafc',
                    background: '#ffffff',
                    mainBkg: '#ffffff',
                    nodeBorder: '#4a6fa5',
                    clusterBkg: '#f7fafc',
                    edgeLabelBackground: '#f7fafc',
                    fontFamily: '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif'
                },
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true,
                    curve: 'basis',
                    rankSpacing: 50,
                    nodeSpacing: 30
                },
                securityLevel: 'loose'
            });
            renderNav();
            renderRecent();
            renderFavorites();

            // Check for hash
            if (window.location.hash) {
                const hash = decodeURIComponent(window.location.hash.slice(1));
                if (hash === 'peptides') {
                    showAllPeptides();
                } else if (hash.startsWith('category/')) {
                    const catKey = hash.replace('category/', '');
                    if (categories[catKey]) showCategoryPage(catKey);
                    else showWelcome();
                } else if (hash) {
                    loadFile(hash, false);
                } else {
                    showWelcome();
                }
            } else {
                showWelcome();
            }

            // Handle popstate
            window.addEventListener('popstate', (e) => {
                if (e.state?.file) loadFile(e.state.file, false);
                else if (e.state?.category) showCategoryPage(e.state.category);
                else if (e.state?.peptides) showAllPeptides();
                else showWelcome();
            });

            // Progress bar on scroll
            window.addEventListener('scroll', updateProgress);

            // Detect OS for shortcut hint
            if (navigator.platform.indexOf('Mac') > -1) {
                document.getElementById('searchHint').textContent = 'K';
                document.getElementById('searchKey').textContent = 'K';
            } else {
                document.getElementById('searchKey').textContent = 'Ctrl+K';
            }
        }

        // Check auth on load
        if (sessionStorage.getItem('auth') === '1') {
            document.getElementById('passwordScreen').classList.add('hidden');
            document.getElementById('app').classList.add('visible');
            init();
        } else {
            document.getElementById('passwordInput').focus();
        }
    </script>
</body>
</html>
